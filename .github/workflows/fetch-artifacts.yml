name: Release ArchLingmo ISO

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'

jobs:
  download-artifact:
    runs-on: ubuntu-latest
    
    steps:      
    - name: Download Artifact
      id: download-artifact
      run: |
        REPO="LingmoOS/archlingmo-archiso-config"
        LATEST_RUN_ID=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/$REPO/actions/runs \
          | jq '.workflow_runs | map(select(.status == "completed")) | first | .id')
        ARTIFACT_ID=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/$REPO/actions/runs/${LATEST_RUN_ID}/artifacts \
          | jq '.artifacts | first | .id')
        curl -L \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/$REPO/actions/artifacts/${ARTIFACT_ID}/zip \
          -o artifact.zip

    - name: Split Artifact
      run: |
        split -b 2G -d -a 3 artifact.zip archlingmo.zip.
        ls -lh

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
          files: archlingmo.zip.*
